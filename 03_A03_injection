# A03:2021 - Injection

### 5.3. A03:2021 – Injection

#### Wyjaśnienie Zagadnienia

**Injection** (Wstrzykiwanie) to klasa podatności polegająca na przekazaniu do aplikacji niezweryfikowanych danych, które są następnie interpretowane przez serwer jako kod lub polecenie systemowe. Najczęstszym i najbardziej krytycznym przykładem jest **SQL Injection**, gdzie atakujący manipuluje zapytaniem do bazy danych, aby uzyskać nieautoryzowany dostęp do informacji, zmodyfikować je lub trwale usunąć.

W analizowanej aplikacji `Quiz-Web-App` przeprowadzono szczegółowy audyt pod kątem występowania podatności typu Injection. Weryfikacja wykazała, że system jest odporny na tego typu ataki dzięki zastosowaniu bezpiecznej architektury opartej na ORM.


#### WERYFIKACJA #1: Odporność na SQL Injection (Analiza kodu)

**Status:** ZABEZPIECZONY
**Technologia:** Spring Data JPA / Hibernate

##### Lokalizacja

**Katalog:** `backend/src/main/java/com/portal/demo/repository/`

##### Opis Weryfikacji

Analiza statyczna kodu (SAST) wykazała, że aplikacja nie konstruuje zapytań SQL poprzez bezpośrednią konkatenację ciągów znaków (sklejanie stringów), co jest główną przyczyną powstawania luk SQL Injection.

Zastosowany framework **Spring Data JPA** oraz interfejsy repozytoriów (np. `QuestionRepository`) wymuszają korzystanie z bezpiecznych mechanizmów. Zapytania generowane przez Hibernate są automatycznie parametryzowane. Oznacza to, że wszelkie dane wejściowe od użytkownika (nawet zawierające znaki specjalne SQL jak `'` czy `--`) są traktowane wyłącznie jako literały (wartości), a nigdy jako wykonywalny kod SQL.

##### Dowód z kodu (Secure Code)

**Plik: QuestionRepository.java**
```java
public interface QuestionRepository extends JpaRepository<Question, Long> {
    // Poniższa metoda generuje bezpieczne, sparametryzowane zapytanie.
    // Spring/Hibernate automatycznie escapuje obiekt 'quiz'.
    Set<Question> findByQuiz(Quiz quiz);
}
````

W kodzie nie zidentyfikowano niebezpiecznych konstrukcji typu:
`String query = "SELECT * FROM users WHERE name = '" + username + "'";`


#### WERYFIKACJA \#2: Testy Manualne i Fuzzing

**Status:** ZABEZPIECZONY
**Metoda:** Manualna eksploitacja payloadów SQLi

##### Zakres testów

Weryfikacji poddano publiczne oraz chronione endpointy przyjmujące parametry identyfikacyjne oraz obiekty JSON, w tym:

  - `GET /category/{id}`
  - `GET /quiz/{id}`
  - `POST /api/v1/auth/authenticate`

##### Opis Weryfikacji

Przeprowadzono próby wstrzyknięcia złośliwego kodu w miejsca, gdzie aplikacja oczekuje id lub ciągu tekstowego. Zastosowano standardowe wektory ataku SQL Injection.

##### Wyniki testów

**1. Test składniowy (Syntax Error Check)**

  - **Payload:** `GET /category/602'`
  - **Wynik:** Kod `400 Bad Request`.
  - **Analiza:** Aplikacja poprawnie odrzuciła żądanie na poziomie walidacji typów danych (oczekiwano typu `Long`, otrzymano `String` z apostrofem). Nie doszło do wycieku błędu bazy danych.

**2. Test logiczny (Boolean-based)**

  - **Payload:** `GET /category/602 OR 1=1`
  - **Wynik:** Kod `400 Bad Request`.
  - **Analiza:** Parametr został odrzucony przed przekazaniem do warstwy bazy danych.

**3. Test obejścia uwierzytelnienia (Auth Bypass)**

  - **Endpoint:** `/auth/authenticate`
  - **Payload (username):** `admin' --`
  - **Wynik:** Kod `401 Unauthorized`.
  - **Analiza:** Mechanizm logowania poprawnie zweryfikował brak użytkownika o podanej nazwie, traktując znaki specjalne jako część loginu, a nie instrukcję SQL.

#### WERYFIKACJA \#3: Automatyczny skan narzędziem sqlmap

**Status:** ZABEZPIECZONY
**Narzędzie:** sqlmap v1.5

##### Opis Weryfikacji

Uruchomiono zautomatyzowane testy penetracyjne przy użyciu narzędzia `sqlmap`, wykonując próby ataków typu Time-based Blind, Union-based oraz Error-based na endpointach komunikujących się z bazą danych.

##### Wynik skanowania

**Komenda:**

```bash
sqlmap -u "http://localhost:8080/category/602" --level=5 --risk=3 --batch
```

**Log wyjściowy:**

```text
[CRITICAL] all tested parameters do not appear to be injectable.
[WARNING] target URL is not injectable
```


#### Podsumowanie Audytu

Audyt bezpieczeństwa w kategorii A03:2021 potwierdził, że aplikacja `Quiz-Web-App` jest odporna na ataki typu Injection.

Wysoki poziom bezpieczeństwa wynika z:

1.  **Użycia warstwy ORM (Hibernate/JPA)**, która eliminuje konieczność ręcznego pisania zapytań SQL.
2.  **Silnego zdefiniowania typów zmiennych w języku Java** (np. wymuszenie typu `Long` dla ID.
3.  **Poprawnej walidacji danych wejściowych** na poziomie kontrolerów REST.

**Rekomendacja:** Utrzymać obecne standardy kodowania i kontynuować używanie sparametryzowanych zapytań we wszystkich nowych funkcjonalnościach.
